
### ğŸª í† í°ê³¼ ì¿ í‚¤ë¡œ ì¸ì¦ ì²´í¬  

![2021-07-28 14 51 28](https://user-images.githubusercontent.com/80666066/127271727-782266cd-85f4-449a-825b-c56b925e6d9c.gif)

ë¡œê·¸ì¸ ì‹œ JSON Web Tokenì„ ì´ìš©í•´ í† í°ì„ ìƒì„±í•´ ì¿ í‚¤ì— ì €ì¥í•œë‹¤  
ì´ ì¿ í‚¤ì˜ í† í° ê°’ì„ ì´ìš©í•´ì„œ í˜ì´ì§€ë§ˆë‹¤ ì‚¬ìš©ìê°€ ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ”ì§€ ì¸ì¦ ì ˆì°¨ë¥¼ ê±°ì¹˜ê²Œ í–ˆë‹¤  
ì„œë²„ë‹¨ì—ì„œëŠ” auth.js ë¯¸ë“¤ì›¨ì–´ë¥¼ í†µí•´ DB ì¡°íšŒ ê²°ê³¼ì— ë”°ë¼ ë‹¤ë¥¸ ì‘ë‹µì„ ë³´ë‚´ì¤€ë‹¤  

<br/>

```javascript
let auth = (req, res, next) => {
    //ì¸ì¦ ì²˜ë¦¬ë¥¼ í•˜ëŠ” ê³³

    //í´ë¼ì´ì–¸íŠ¸ ì¿ í‚¤ì—ì„œ í† í°ì„ ê°€ì ¸ì˜¨ë‹¤ 
    let token = req.cookies.x_auth;

    //í† í°ì„ ë³µí˜¸í™” í•œ í›„, ìœ ì €ë¥¼ ì°¾ëŠ”ë‹¤ 
    User.findByToken(token, (err, user) => {
        if(err) throw err;
        if(!user) return res.json({ isAuth: false, error: true})

        req.token = token;
        req.user = user;
        next();
    })

    //ìœ ì €ê°€ ìˆìœ¼ë©´ ì¸ì¦ Okay
    //ìœ ì €ê°€ ì—†ìœ¼ë©´ ì¸ì¦ No
}
```

<br/>

User ìŠ¤í‚¤ë§ˆì˜ findByToken ë©”ì„œë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤  

<br/>

```javascript
userSchema.statics.findByToken = function(token, cb) {
    var user = this;

    //í† í°ì„ decode
    jwt.verify(token, 'secretToken', function(err, decoded){

        //ìœ ì € ì•„ì´ë””ë¥¼ ì´ìš©í•´ ìœ ì €ë¥¼ ì°¾ì€ ë‹¤ìŒ
        //í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê°€ì ¸ì˜¨ tokenê³¼ 
        //DBì— ë³´ê´€ëœ í† í°ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
        user.findOne({"_id": decoded, "token": token}, function(err, user){
            if(err) return cb(err);
            cb(null, user)
        })
    })
}
```

<br/>

í´ë¼ì´ì–¸íŠ¸ ë‹¨ì—ì„œëŠ” ê³ ì°¨ ì»´í¬ë„ŒíŠ¸ë¡œ ì‘ì„±í•œ auth.jsë¥¼ í†µí•´ì„œ  
ì„œë²„ë‹¨ì—ì„œ ì‘ë‹µí•œ ê°’ì— ë”°ë¼ ì‚¬ìš©ìë¥¼ ì–´ëŠ ì£¼ì†Œë¡œ ë³´ë‚¼ ì§€ ì •í•œë‹¤  

<br/>

```javascript
export default function (SpecificComponent, option, adminRoute = null) {

    //      ~ option ~
    // null     -> ì•„ë¬´ë‚˜ ì¶œì…
    // true     -> ë¡œê·¸ì¸ í•œ ìœ ì €ë§Œ ì¶œì… ê°€ëŠ¥
    // false    -> ë¡œê·¸ì¸ í•œ ìœ ì €ëŠ” ì¶œì… ë¶ˆê°€

    function AuthenticationCheck(props) {
        
        const dispatch = useDispatch();

        useEffect(() => {
            
            dispatch(auth()).then(response => {

                //ë¡œê·¸ì¸ í•˜ì§€ ì•Šì€ ìƒíƒœ
                if(!response.payload.isAuth){
                    if(option) {
                        props.history.pust('/login')
                    }
                } else {
                    //ë¡œê·¸ì¸ í•œ ìƒíƒœ 
                    if(adminRoute && !response.payload.isAdmin) {
                        props.history.push('/')
                    } else {
                        if(!option) {
                            props.history.push('')
                        }
                    }
                }
            })

        }, [])

        return (
            <SpecificComponent />
        )
    }

    return AuthenticationCheck
}
```

<br/>

ì—¬ê¸°ì„œ ì‚¬ìš©ëœ user_actionì˜ auth ë©”ì„œë“œì—ì„œ ì„œë²„ì— í†µì‹ ì„ ë³´ë‚´ëŠ”ë°, ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤  

<br/>

```javascript
export function auth() {
    const request = axios.get('/api/users/auth')
        .then(response => response.data )

    return {
        type: AUTH_USER,
        payload: request
    }
}
```

<br/>

ê²°ê³¼ì ìœ¼ë¡œ App.jsì—ì„œ ì¸ì¦ì€ ì´ë ‡ê²Œ ì ìš©ë˜ì—ˆë‹¤  

<br/>

```javascript
<Switch>
    <Route exact path="/" component={ Auth(LandingPage, null) }/>
    <Route path="/login" component={ Auth(LoginPage, false)}/>
    <Route path="/register" component={ Auth(RegisterPage, false)}/>
</Switch>
```

<br/>

LandingPageëŠ” ì¸ì¦ì— ìƒê´€ì—†ì´ ì•„ë¬´ë‚˜,  
LoginPageì™€ RegisterPageëŠ” ë¡œê·¸ì¸ í•˜ì§€ ì•Šì€ ì´ìš©ìë§Œ ì¶œì…í•  ìˆ˜ ìˆë‹¤  

<br/>


